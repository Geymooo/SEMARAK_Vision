<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Air Quality Monitor - RT Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-app-compat.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-check-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .camera-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
            margin-bottom: 25px;
        }

        .camera-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3em;
        }

        .camera-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .camera-input {
            flex: 1;
            min-width: 250px;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .camera-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .camera-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
        }

        .camera-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
        }

        .camera-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            background: #000;
        }

        .camera-stream {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: contain;
            display: block;
        }

        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            transition: all 0.3s ease;
        }

        .camera-placeholder {
            text-align: center;
            color: #7f8c8d;
            font-size: 1.1em;
        }

        .camera-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .camera-status.online {
            background: rgba(46, 204, 113, 0.1);
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .camera-status.offline {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .camera-status.loading {
            background: rgba(243, 156, 18, 0.1);
            color: #f39c12;
            border: 2px solid #f39c12;
        }

        .camera-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }

        .camera-info-item {
            text-align: center;
        }

        .camera-info-item .label {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .camera-info-item .value {
            font-size: 1.1em;
            font-weight: bold;
            color: #1e293b;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInDown 1s ease-out;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .refresh-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .firebase-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .firebase-connected {
            color: #27ae60;
            border: 2px solid #27ae60;
        }

        .firebase-disconnected {
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }

        .firebase-connecting {
            color: #f39c12;
            border: 2px solid #f39c12;
        }

        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .status-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.1em;
        }

        .status-value {
            font-size: 2.2em;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .status-good {
            color: #27ae60;
        }

        .status-moderate {
            color: #f39c12;
        }

        .status-unhealthy {
            color: #e74c3c;
        }

        .status-dangerous {
            color: #8e44ad;
        }

        .status-hazardous {
            color: #7e0023;
        }

        .device-status-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-online {
            background-color: #27ae60;
        }

        .status-offline {
            background-color: #e74c3c;
        }

        .live-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            animation: fadeInUp 0.8s ease-out;
        }

        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .data-card h4 {
            color: #34495e;
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .data-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2980b9;
            margin-bottom: 5px;
        }

        .data-unit {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .google-air-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .google-air-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .google-loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .google-air-data {
            display: none;
        }

        .google-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .google-summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .google-summary-card:hover {
            transform: translateY(-3px);
            border-color: #3498db;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.15);
        }

        .google-summary-card .label {
            color: #64748b;
            font-size: 0.95em;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .google-summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .google-summary-card .category {
            font-size: 0.85em;
            color: #64748b;
            text-transform: capitalize;
        }

        .pollutant-section {
            margin-top: 25px;
        }

        .pollutant-section h4 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pollutant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .pollutant-item {
            background: white;
            padding: 18px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .pollutant-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
            border-color: #3498db;
        }

        .pollutant-item .label {
            font-size: 0.85em;
            color: #64748b;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pollutant-item .value {
            font-weight: bold;
            color: #1e293b;
            font-size: 1.3em;
            margin-bottom: 5px;
        }

        .pollutant-item .unit {
            font-size: 0.75em;
            color: #94a3b8;
        }

        .google-footer {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e6fffa 0%, #b2f5ea 100%);
            border-radius: 10px;
            border-left: 4px solid #38b2ac;
        }

        .google-footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .google-footer-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2d3748;
            font-size: 0.9em;
        }

        .google-footer-item strong {
            color: #1a202c;
        }

        .alerts {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            animation: fadeInUp 0.8s ease-out;
        }

        .alerts h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-item {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
            animation: slideIn 0.5s ease-out;
        }

        .alert-warning {
            border-left-color: #f39c12;
            background: #fef9e7;
        }

        .alert-info {
            border-left-color: #3498db;
            background: #ebf5fb;
        }

        .alert-success {
            border-left-color: #27ae60;
            background: #eafaf1;
        }

        .recommendations {
            background: #f0f8ff;
            border-left: 4px solid #3498db;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .recommendations h4 {
            color: #2980b9;
            margin-bottom: 15px;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }

        .recommendations li:before {
            content: "💡";
            position: absolute;
            left: 0;
        }

        .api-error {
            text-align: center;
            padding: 30px;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 10px;
            color: #c33;
        }

        .timestamp {
            text-align: center;
            color: #7f8c8d;
            margin-top: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0.3;
            }
        }

        .connection-warning {
            animation: blink 1s infinite;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .status-overview {
                grid-template-columns: repeat(2, 1fr);
            }

            .live-data {
                grid-template-columns: repeat(2, 1fr);
            }

            .google-summary {
                grid-template-columns: 1fr;
            }

            .pollutant-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .header h1 {
                font-size: 2em;
            }

            .header-controls {
                flex-direction: column;
                gap: 15px;
            }

            .google-footer-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>SEMARAK-Vision</h1>
            <p>Monitoring Kualitas Udara RT Berbasis IoT dengan Sensor MQ135</p>
            <div class="header-controls">
                <button class="refresh-btn" onclick="refreshData()">🔄 Refresh Data</button>
                <div class="firebase-status firebase-connecting" id="firebaseStatus">
                    <div class="status-dot" id="firebaseDot"></div>
                    <span id="firebaseStatusText">Menghubungkan...</span>
                </div>
            </div>
        </div>

        <!-- Camera Section - Add this after the live-data div -->
        <div class="camera-section">
            <h3>📹 Live Camera Feed - ESP32-CAM</h3>

            <div class="camera-controls">
                <input type="text" class="camera-input" id="cameraIpInput"
                    placeholder="Masukkan IP ESP32-CAM (contoh: 192.168.1.100)" value="192.168.1.100">
                <button class="camera-btn" onclick="connectCamera()" id="connectBtn">
                    🔗 Connect Camera
                </button>
                <button class="camera-btn" onclick="disconnectCamera()" id="disconnectBtn" disabled>
                    🔌 Disconnect
                </button>
            </div>

            <div class="camera-container">
                <img id="cameraStream" class="camera-stream" style="display: none;" alt="ESP32-CAM Live Stream">
                <div class="camera-overlay" id="cameraOverlay">
                    <div class="camera-placeholder">
                        <h3>📱 ESP32-CAM Live Stream</h3>
                        <p>Masukkan IP address ESP32-CAM dan klik "Connect Camera"</p>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #95a5a6;">
                            Pastikan ESP32-CAM sudah terhubung ke jaringan WiFi yang sama
                        </p>
                    </div>
                </div>
            </div>

            <div class="camera-status offline" id="cameraStatus">
                <div class="status-dot"></div>
                <span>Camera Offline</span>
            </div>

            <div class="camera-info">
                <div class="camera-info-item">
                    <div class="label">Stream URL</div>
                    <div class="value" id="streamUrl">Not Connected</div>
                </div>
                <div class="camera-info-item">
                    <div class="label">Resolution</div>
                    <div class="value" id="streamResolution">VGA (640x480)</div>
                </div>
                <div class="camera-info-item">
                    <div class="label">Frame Rate</div>
                    <div class="value" id="streamFramerate">~30 FPS</div>
                </div>
                <div class="camera-info-item">
                    <div class="label">Flash LED</div>
                    <div class="value" id="flashStatus">Always ON</div>
                </div>
            </div>
        </div>

        <div class="status-overview">
            <div class="status-card">
                <h3>🌬️ Status Udara</h3>
                <div class="status-value" id="airStatus">Loading...</div>
                <div class="device-status-indicator">
                    <div class="status-dot" id="deviceDot"></div>
                    <small id="deviceStatusText">Checking...</small>
                </div>
            </div>
            <div class="status-card">
                <h3>📊 AQI</h3>
                <div class="status-value" id="aqiValue">-</div>
                <small>Air Quality Index</small>
            </div>
            <div class="status-card">
                <h3>📡 Device Status</h3>
                <div class="status-value status-good" id="sensorStatus">Online</div>
                <small>ESP32 + MQ135</small>
            </div>
            <div class="status-card">
                <h3>⏰ Waktu</h3>
                <div class="status-value" id="lastUpdate">-</div>
            </div>
        </div>

        <div class="live-data">
            <div class="data-card">
                <h4>🔥 CO₂</h4>
                <div class="data-value" id="co2Value">-</div>
                <div class="data-unit">ppm</div>
            </div>
            <div class="data-card">
                <h4>💨 NH₃</h4>
                <div class="data-value" id="nh3Value">-</div>
                <div class="data-unit">ppm</div>
            </div>
            <div class="data-card">
                <h4>🍷 Alkohol</h4>
                <div class="data-value" id="alcoholValue">-</div>
                <div class="data-unit">ppm</div>
            </div>
            <div class="data-card">
                <h4>⚗️ Benzena</h4>
                <div class="data-value" id="benzeneValue">-</div>
                <div class="data-unit">ppm</div>
            </div>
            <div class="data-card">
                <h4>🔧 Raw Sensor</h4>
                <div class="data-value" id="rawValue">-</div>
                <div class="data-unit">ADC</div>
            </div>
        </div>

        <div class="main-content">
            <div class="chart-container" style="display:none;">
                <canvas id="airQualityChart" width="400" height="200"></canvas>
            </div>

            <div class="google-air-section">
                <h3>🌐 Data Regional Air Quality by Google Maps API</h3>
                <div id="googleAirQuality">
                    <div class="google-loading" id="googleLoading">
                        <div class="spinner"></div>
                        <p>Memuat data kualitas udara regional...</p>
                    </div>

                    <div class="google-air-data" id="googleAirData">
                        <div class="google-summary">
                            <div class="google-summary-card">
                                <div class="label">🏆 AQI Regional</div>
                                <div class="value" id="googleAQI">--</div>
                                <div class="category" id="googleCategory">--</div>
                            </div>
                            <div class="google-summary-card">
                                <div class="label">🎯 Status Dominan</div>
                                <div class="value" id="dominantPollutant">--</div>
                                <div class="category">Polutan Utama</div>
                            </div>
                            <div class="google-summary-card">
                                <div class="label">🌡️ Rekomendasi</div>
                                <div class="value" id="healthRecommendation" style="font-size: 1.2em;">--</div>
                                <div class="category">Saran Kesehatan</div>
                            </div>
                        </div>

                        <div class="pollutant-section">
                            <h4>📊 Detail Konsentrasi Polutan Regional</h4>
                            <div class="pollutant-grid">
                                <div class="pollutant-item">
                                    <div class="label">PM2.5</div>
                                    <div class="value" id="pm25">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                                <div class="pollutant-item">
                                    <div class="label">PM10</div>
                                    <div class="value" id="pm10">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                                <div class="pollutant-item">
                                    <div class="label">O3</div>
                                    <div class="value" id="o3">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                                <div class="pollutant-item">
                                    <div class="label">NO2</div>
                                    <div class="value" id="no2">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                                <div class="pollutant-item">
                                    <div class="label">SO2</div>
                                    <div class="value" id="so2">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                                <div class="pollutant-item">
                                    <div class="label">CO</div>
                                    <div class="value" id="co">--</div>
                                    <div class="unit">μg/m³</div>
                                </div>
                            </div>
                        </div>

                        <div class="google-footer">
                            <div class="google-footer-content">
                                <div class="google-footer-item">
                                    <span>🌍</span>
                                    <span><strong>Lokasi:</strong> <span id="googleDataSource">Jakarta Timur,
                                            Indonesia</span></span>
                                </div>
                                <div class="google-footer-item">
                                    <span>⏰</span>
                                    <span><strong>Update Regional:</strong> <span id="googleUpdateTime">--</span></span>
                                </div>
                                <div class="google-footer-item">
                                    <span>🔄</span>
                                    <span><strong>Akan di-Refresh:</strong> <span
                                            id="googleNextRefresh">--</span></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="googleError" class="api-error" style="display: none;">
                        <h4>⚠️ Koneksi API Terputus</h4>
                        <p>Tidak dapat mengakses Google Air Quality API</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Periksa koneksi internet atau konfigurasi API key
                        </p>
                    </div>
                </div>
            </div>

            <div class="alerts">
                <h3>Peringatan</h3>
                <div id="alertsList">
                    <div class="loading">Memuat peringatan...</div>
                </div>

                <div class="recommendations" id="recommendations">
                    <h4>💡 Rekomendasi Berdasarkan Kualitas Udara:</h4>
                    <ul id="recommendationList">
                        <li>Menunggu data sensor...</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="timestamp">
            <strong>Data Terakhir Diperbarui:</strong> <span id="updateTime">-</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB3_N3pDJpF9mUYJrRH-Y8cLEXNjZh1EP8",
            authDomain: "semarak-vision.firebaseapp.com",
            databaseURL: "https://semarak-vision-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "semarak-vision",
            storageBucket: "semarak-vision.firebasestorage.app",
            messagingSenderId: "362280291890",
            appId: "1:362280291890:web:f619a30788db3248bef62b"
        };

        // Google Air Quality API configuration
        const GOOGLE_AIR_QUALITY_API_KEY = 'AIzaSyBTe4sKKleJYWwTcC4aRIvLeFDV8wBkCZM';

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const appCheck = firebase.appCheck();
        appCheck.activate('6LdWX70rAAAAAMQXHl0CSQjGE8nIsEX0wxwolXdd', true);
        const database = firebase.database();

        // Connection status tracking
        let firebaseConnected = false;
        let lastDataReceived = null;
        let dataTimeoutTimer = null;
        let connectionCheckTimer = null;

        // Chart.js setup
        let airQualityChart;

        // Default RT location
        const RT_LOCATION = {
            lat: -6.222870475586725,
            lng: 106.8926745769288,
            name: "RT 013 RW 015 Kelurahan Cipinang Muara",
            device_id: "RT013_RW015_KEL_CM"
        };

        // Current data store
        let currentData = null;
        let chartData = {
            labels: [],
            aqi: [],
            co2: [],
            nh3: [],
            alcohol: [],
            benzene: []
        };

        // =========================
        // Camera Variables (ditambah)
        // =========================
        let cameraConnected = false;
        let currentCameraIP = '';
        let cameraCheckInterval = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            initializeChart();
            initializeFirebaseConnection();
            fetchGoogleAirQuality();

            // Enter untuk konek kamera
            const cameraInput = document.getElementById('cameraIpInput');
            if (cameraInput) {
                cameraInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') connectCamera();
                });
            }

            // Auto refresh every 30 seconds
            setInterval(refreshData, 30000);
            // Refresh Google data every 10 minutes
            setInterval(fetchGoogleAirQuality, 600000);

            // Check connection status every 1 second
            setInterval(checkConnectionStatus, 1000);
        });

        function initializeFirebaseConnection() {
            updateFirebaseStatus('connecting', 'Menghubungkan...');

            // Monitor Firebase connection
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                firebaseConnected = snapshot.val() === true;

                if (firebaseConnected) {
                    updateFirebaseStatus('connected', 'Terhubung');
                    startRealtimeUpdates();
                } else {
                    updateFirebaseStatus('disconnected', 'Terputus');
                }
            });
        }

        function updateFirebaseStatus(status, text) {
            const statusElement = document.getElementById('firebaseStatus');
            const dotElement = document.getElementById('firebaseDot');
            const textElement = document.getElementById('firebaseStatusText');

            // Remove all status classes
            statusElement.classList.remove('firebase-connected', 'firebase-disconnected', 'firebase-connecting');
            dotElement.classList.remove('status-online', 'status-offline');

            switch (status) {
                case 'connected':
                    statusElement.classList.add('firebase-connected');
                    dotElement.classList.add('status-online');
                    break;
                case 'disconnected':
                    statusElement.classList.add('firebase-disconnected');
                    dotElement.classList.add('status-offline');
                    break;
                case 'connecting':
                    statusElement.classList.add('firebase-connecting');
                    dotElement.classList.add('status-offline');
                    break;
            }

            textElement.textContent = text;
        }

        function checkConnectionStatus() {
            if (lastDataReceived) {
                const now = Date.now();
                const timeDiff = now - lastDataReceived;

                // If no data received for 35 seconds, mark device as offline
                if (timeDiff > 35000) {
                    updateDeviceStatus('offline');
                } else {
                    updateDeviceStatus('online');
                }
            }
        }

        function updateDeviceStatus(status) {
            const deviceDot = document.getElementById('deviceDot');
            const deviceStatusText = document.getElementById('deviceStatusText');
            const sensorStatus = document.getElementById('sensorStatus');

            if (status === 'online') {
                deviceDot.className = 'status-dot status-online';
                deviceStatusText.textContent = 'Online';
                sensorStatus.textContent = 'Online';
                sensorStatus.className = 'status-value status-good';
            } else {
                deviceDot.className = 'status-dot status-offline';
                deviceStatusText.textContent = 'Offline';
                sensorStatus.textContent = 'Offline';
                sensorStatus.className = 'status-value status-unhealthy';
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('airQualityChart').getContext('2d');
            airQualityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'AQI',
                        data: chartData.aqi,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }, {
                        label: 'CO₂ (ppm)',
                        data: chartData.co2,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: { display: true, text: 'Waktu' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'AQI' },
                            min: 0,
                            max: 500
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'CO₂ (ppm)' },
                            grid: { drawOnChartArea: false },
                        }
                    }
                }
            });
        }

        function startRealtimeUpdates() {
            // Listen to current data
            const currentRef = database.ref('/air_quality/current/' + RT_LOCATION.device_id);
            currentRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentData = data;
                    lastDataReceived = Date.now();
                    updateCurrentDataDisplay(data);
                    updateAlerts(data);

                    // Clear any existing timeout
                    if (dataTimeoutTimer) {
                        clearTimeout(dataTimeoutTimer);
                    }
                }
            });

            // Listen to historical data for chart
            const historyRef = database.ref('/air_quality/history/' + RT_LOCATION.device_id);
            historyRef.limitToLast(24).on('value', (snapshot) => {
                const historyData = snapshot.val();
                if (historyData) {
                    updateChartData(historyData);
                }
            });
        }

        function updateCurrentDataDisplay(data) {
            // Update status cards
            document.getElementById('airStatus').textContent = data.status || 'Unknown';
            document.getElementById('aqiValue').textContent = data.aqi || '-';

            // Color code AQI
            const aqiElement = document.getElementById('aqiValue');
            const statusElement = document.getElementById('airStatus');
            const aqi = data.aqi || 0;

            if (aqi <= 50) {
                aqiElement.className = 'status-value status-good';
                statusElement.className = 'status-value status-good';
            } else if (aqi <= 100) {
                aqiElement.className = 'status-value status-moderate';
                statusElement.className = 'status-value status-moderate';
            } else if (aqi <= 200) {
                aqiElement.className = 'status-value status-unhealthy';
                statusElement.className = 'status-value status-unhealthy';
            } else if (aqi <= 300) {
                aqiElement.className = 'status-value status-dangerous';
                statusElement.className = 'status-value status-dangerous';
            } else {
                aqiElement.className = 'status-value status-hazardous';
                statusElement.className = 'status-value status-hazardous';
            }

            // Update gas readings
            document.getElementById('co2Value').textContent = parseFloat(data.co2_ppm || 0).toFixed(1);
            document.getElementById('nh3Value').textContent = parseFloat(data.nh3_ppm || 0).toFixed(1);
            document.getElementById('alcoholValue').textContent = parseFloat(data.alcohol_ppm || 0).toFixed(1);
            document.getElementById('benzeneValue').textContent = parseFloat(data.benzene_ppm || 0).toFixed(2);
            document.getElementById('rawValue').textContent = data.raw_sensor_value || '-';

            // Update timestamps
            const timestamp = new Date(data.timestamp);
            document.getElementById('lastUpdate').textContent = timestamp.toLocaleTimeString('id-ID');
            document.getElementById('updateTime').textContent = timestamp.toLocaleString('id-ID');
        }

        function updateChartData(historyData) {
            chartData.labels = [];
            chartData.aqi = [];
            chartData.co2 = [];
            chartData.nh3 = [];
            chartData.alcohol = [];
            chartData.benzene = [];

            Object.keys(historyData).forEach(key => {
                const data = historyData[key];
                const time = new Date(data.timestamp);

                chartData.labels.push(time.toLocaleTimeString('id-ID', {
                    hour: '2-digit',
                    minute: '2-digit'
                }));
                chartData.aqi.push(data.aqi || 0);
                chartData.co2.push(data.co2_ppm || 0);
                chartData.nh3.push(data.nh3_ppm || 0);
                chartData.alcohol.push(data.alcohol_ppm || 0);
                chartData.benzene.push(data.benzene_ppm || 0);
            });

            if (airQualityChart) {
                airQualityChart.data.labels = chartData.labels;
                airQualityChart.data.datasets[0].data = chartData.aqi;
                airQualityChart.data.datasets[1].data = chartData.co2;
                airQualityChart.update();
            }
        }

        function updateAlerts(data) {
            const alertsList = document.getElementById('alertsList');
            const aqi = data.aqi || 0;
            let alerts = [];

            // Firebase connection alert
            if (!firebaseConnected) {
                alerts.push({
                    type: 'alert-item',
                    message: `🔥 Koneksi Firebase terputus - Data mungkin tidak real-time`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            // Data freshness alert
            if (lastDataReceived) {
                const timeDiff = Date.now() - lastDataReceived;
                if (timeDiff > 60000) { // More than 1 minute
                    alerts.push({
                        type: 'alert-warning',
                        message: `⏰ Data sensor tidak diperbarui selama ${Math.floor(timeDiff / 60000)} menit`,
                        time: new Date().toLocaleTimeString('id-ID')
                    });
                }
            }

            // Generate alerts based on AQI and gas levels
            if (aqi > 300) {
                alerts.push({
                    type: 'alert-item',
                    message: `🚨 BAHAYA TINGGI! AQI ${aqi} - Kualitas udara berbahaya untuk semua kelompok`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            } else if (aqi > 200) {
                alerts.push({
                    type: 'alert-item',
                    message: `⚠️ PERINGATAN! AQI ${aqi} - Kualitas udara sangat tidak sehat`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            } else if (aqi > 150) {
                alerts.push({
                    type: 'alert-warning',
                    message: `⚠️ Perhatian! AQI ${aqi} - Tidak sehat untuk kelompok sensitif`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            // Check specific gas levels
            if (data.co2_ppm > 2000) {
                alerts.push({
                    type: 'alert-warning',
                    message: `💨 Kadar CO₂ tinggi: ${parseFloat(data.co2_ppm).toFixed(1)} ppm`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            if (data.nh3_ppm > 50) {
                alerts.push({
                    type: 'alert-item',
                    message: `⚠️ Kadar NH₃ berbahaya: ${parseFloat(data.nh3_ppm).toFixed(1)} ppm`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            if (data.benzene_ppm > 5) {
                alerts.push({
                    type: 'alert-item',
                    message: `☠️ Kadar Benzena tinggi: ${parseFloat(data.benzene_ppm).toFixed(2)} ppm`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            // Show good air quality message if no alerts
            if (alerts.length === 0 && aqi <= 100) {
                alerts.push({
                    type: 'alert-success',
                    message: `✅ Kualitas udara dalam kondisi baik - AQI ${aqi}`,
                    time: new Date().toLocaleTimeString('id-ID')
                });
            }

            // Update alerts display
            alertsList.innerHTML = alerts.map(alert => `
                <div class="${alert.type}">
                    <strong>${alert.message}</strong><br>
                    <small>Waktu: ${alert.time}</small>
                </div>
            `).join('');

            // Update recommendations
            updateRecommendations(aqi);
        }

        function updateRecommendations(aqi) {
            const recommendationList = document.getElementById('recommendationList');
            let recommendations = [];

            if (aqi <= 50) {
                recommendations = [
                    'Kualitas udara sangat baik untuk semua aktivitas',
                    'Aman untuk olahraga dan aktivitas luar ruangan',
                    'Jendela boleh dibuka untuk sirkulasi udara alami'
                ];
            } else if (aqi <= 100) {
                recommendations = [
                    'Kualitas udara dapat diterima untuk sebagian besar orang',
                    'Kelompok sensitif sebaiknya membatasi aktivitas luar ruangan yang berat',
                    'Aman untuk aktivitas normal'
                ];
            } else if (aqi <= 150) {
                recommendations = [
                    'Kelompok sensitif sebaiknya mengurangi aktivitas luar ruangan',
                    'Gunakan masker jika harus beraktivitas di luar',
                    'Batasi olahraga luar ruangan untuk kelompok sensitif'
                ];
            } else if (aqi <= 200) {
                recommendations = [
                    'Semua orang sebaiknya membatasi aktivitas luar ruangan',
                    'Gunakan masker N95 saat keluar rumah',
                    'Tutup jendela dan gunakan pembersih udara jika ada'
                ];
            } else if (aqi <= 300) {
                recommendations = [
                    'Hindari semua aktivitas luar ruangan',
                    'Gunakan masker berkualitas tinggi jika terpaksa keluar',
                    'Kelompok rentan sebaiknya tetap di dalam ruangan',
                    'Konsultasi dengan dokter jika mengalami gejala'
                ];
            } else {
                recommendations = [
                    'BAHAYA! Jangan keluar rumah kecuali dalam keadaan darurat',
                    'Semua orang berisiko mengalami efek kesehatan serius',
                    'Gunakan pembersih udara dan tutup semua ventilasi',
                    'Segera hubungi layanan kesehatan jika mengalami gejala'
                ];
            }

            recommendationList.innerHTML = recommendations.map(rec => `<li>${rec}</li>`).join('');
        }

        // Google Air Quality API
        async function fetchGoogleAirQuality() {
            const googleLoading = document.getElementById('googleLoading');
            const googleAirData = document.getElementById('googleAirData');
            const googleError = document.getElementById('googleError');

            try {
                googleLoading.style.display = 'block';
                googleAirData.style.display = 'none';
                googleError.style.display = 'none';

                const response = await fetch(
                    `https://airquality.googleapis.com/v1/currentConditions:lookup?key=${GOOGLE_AIR_QUALITY_API_KEY}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            location: { latitude: RT_LOCATION.lat, longitude: RT_LOCATION.lng },
                            universal_aqi: true,
                            extraComputations: [
                                "HEALTH_RECOMMENDATIONS",
                                "POLLUTANT_CONCENTRATION",
                                "LOCAL_AQI",
                                "POLLUTANT_ADDITIONAL_INFO"
                            ]
                        })
                    }
                );

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                updateGoogleAirQualityUI(data);

            } catch (error) {
                console.error('Error fetching Google Air Quality data:', error);
                googleLoading.style.display = 'none';
                googleAirData.style.display = 'none';
                googleError.style.display = 'block';

                // Show demo data if API fails
                showGoogleDemoData();
            }
        }

        function updateGoogleAirQualityUI(data) {
            const googleLoading = document.getElementById('googleLoading');
            const googleAirData = document.getElementById('googleAirData');
            const googleError = document.getElementById('googleError');

            googleLoading.style.display = 'none';
            googleAirData.style.display = 'block';
            googleError.style.display = 'none';

            // Update main AQI
            const universalAqi = data.indexes?.find(index => index.code === 'uaqi');
            if (universalAqi) {
                document.getElementById('googleAQI').textContent = universalAqi.aqi;
                document.getElementById('googleCategory').textContent = universalAqi.category;

                const aqi = universalAqi.aqi;
                const color = getAQIColor(aqi);
                document.getElementById('googleAQI').style.color = color;
            }

            // Find dominant pollutant
            let dominantPollutant = 'N/A';
            if (data.indexes && data.indexes.length > 0) {
                const dominantIndex = data.indexes.reduce((prev, current) =>
                    (prev.aqi > current.aqi) ? prev : current
                );
                dominantPollutant = dominantIndex.displayName || dominantIndex.code;
            }
            document.getElementById('dominantPollutant').textContent = dominantPollutant;

            // Health recommendation
            const healthRec = data.healthRecommendations?.generalPopulation || 'Tidak ada rekomendasi';
            document.getElementById('healthRecommendation').textContent =
                healthRec.length > 30 ? healthRec.substring(0, 30) + '...' : healthRec;

            // Update pollutant data
            if (data.pollutants) {
                // Reset all values first
                ['pm25', 'pm10', 'o3', 'no2', 'so2', 'co'].forEach(id => {
                    document.getElementById(id).textContent = '--';
                });

                data.pollutants.forEach(pollutant => {
                    const elementId = pollutant.code.toLowerCase().replace('.', '').replace('_', '');
                    const element = document.getElementById(elementId);
                    if (element && pollutant.concentration) {
                        const value = pollutant.concentration.value;
                        element.textContent = value.toFixed(1);
                    }
                });
            }

            // Update timestamps
            const now = new Date();
            document.getElementById('googleUpdateTime').textContent = now.toLocaleString('id-ID');

            // Calculate next refresh time (10 minutes from now)
            const nextRefresh = new Date(now.getTime() + 10 * 60000);
            document.getElementById('googleNextRefresh').textContent = nextRefresh.toLocaleTimeString('id-ID');
        }

        function showGoogleDemoData() {
            // Show demo data when API is not available
            const googleLoading = document.getElementById('googleLoading');
            const googleAirData = document.getElementById('googleAirData');
            const googleError = document.getElementById('googleError');

            googleLoading.style.display = 'none';
            googleError.style.display = 'none';
            googleAirData.style.display = 'block';

            // Demo data
            const demoAQI = Math.floor(Math.random() * 150) + 50;
            const demoColor = getAQIColor(demoAQI);

            document.getElementById('googleAQI').textContent = demoAQI;
            document.getElementById('googleAQI').style.color = demoColor;
            document.getElementById('googleCategory').textContent = getAQIStatus(demoAQI);
            document.getElementById('dominantPollutant').textContent = 'PM2.5';
            document.getElementById('healthRecommendation').textContent = 'Aman untuk aktivitas normal';

            // Demo pollutant values
            document.getElementById('pm25').textContent = (Math.random() * 50 + 10).toFixed(1);
            document.getElementById('pm10').textContent = (Math.random() * 80 + 20).toFixed(1);
            document.getElementById('o3').textContent = (Math.random() * 100 + 50).toFixed(1);
            document.getElementById('no2').textContent = (Math.random() * 40 + 10).toFixed(1);
            document.getElementById('so2').textContent = (Math.random() * 20 + 5).toFixed(1);
            document.getElementById('co').textContent = (Math.random() * 2000 + 500).toFixed(1);

            const now = new Date();
            document.getElementById('googleUpdateTime').textContent = now.toLocaleString('id-ID');
            const nextRefresh = new Date(now.getTime() + 10 * 60000);
            document.getElementById('googleNextRefresh').textContent = nextRefresh.toLocaleTimeString('id-ID');
        }

        function getAQIColor(aqi) {
            if (aqi <= 50) return '#27ae60';      // Green
            else if (aqi <= 100) return '#f39c12';   // Yellow
            else if (aqi <= 150) return '#e67e22';   // Orange
            else if (aqi <= 200) return '#e74c3c';   // Red
            else if (aqi <= 300) return '#8e44ad';   // Purple
            else return '#7e0023';                   // Maroon
        }

        function getAQIStatus(aqi) {
            if (aqi <= 50) return 'Baik';
            else if (aqi <= 100) return 'Sedang';
            else if (aqi <= 150) return 'Tidak Sehat untuk Kelompok Sensitif';
            else if (aqi <= 200) return 'Tidak Sehat';
            else if (aqi <= 300) return 'Sangat Tidak Sehat';
            else return 'Berbahaya';
        }

        function refreshData() {
            console.log('Refreshing data...');

            // Simulate data if Firebase is not connected or no real data
            if (!firebaseConnected || !currentData) {
                simulateLocalData();
            }

            // Refresh Google data
            fetchGoogleAirQuality();

            // Update refresh time
            document.getElementById('updateTime').textContent = new Date().toLocaleString('id-ID');
        }

        // Simulate local sensor data for demo purposes
        function simulateLocalData() {
            const demoData = {
                device_id: RT_LOCATION.device_id,
                location_id: RT_LOCATION.device_id,
                location_name: RT_LOCATION.name,
                latitude: RT_LOCATION.lat,
                longitude: RT_LOCATION.lng,
                timestamp: new Date().toISOString(),
                raw_sensor_value: Math.floor(Math.random() * 4095),
                co2_ppm: Math.random() * 1000 + 400,
                nh3_ppm: Math.random() * 100,
                alcohol_ppm: Math.random() * 50,
                benzene_ppm: Math.random() * 10,
                aqi: Math.floor(Math.random() * 200) + 50,
                status: '',
                status_color: '',
                device_status: 'online'
            };

            demoData.aqi = calculateSimulatedAQI(demoData);
            demoData.status = getAQIStatus(demoData.aqi);
            demoData.status_color = getAQIColor(demoData.aqi);

            currentData = demoData;
            lastDataReceived = Date.now();
            updateCurrentDataDisplay(demoData);
            updateAlerts(demoData);

            // Add to chart data
            const time = new Date().toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });

            chartData.labels.push(time);
            chartData.aqi.push(demoData.aqi);
            chartData.co2.push(demoData.co2_ppm);

            // Keep only last 24 data points
            if (chartData.labels.length > 24) {
                chartData.labels.shift();
                chartData.aqi.shift();
                chartData.co2.shift();
            }

            if (airQualityChart) {
                airQualityChart.data.labels = chartData.labels;
                airQualityChart.data.datasets[0].data = chartData.aqi;
                airQualityChart.data.datasets[1].data = chartData.co2;
                airQualityChart.update();
            }
        }

        function calculateSimulatedAQI(data) {
            let aqi = 50; // Base AQI

            // CO2 contribution
            if (data.co2_ppm > 2000) aqi += 80;
            else if (data.co2_ppm > 1500) aqi += 60;
            else if (data.co2_ppm > 1000) aqi += 40;
            else if (data.co2_ppm > 800) aqi += 20;

            // NH3 contribution
            if (data.nh3_ppm > 75) aqi += 100;
            else if (data.nh3_ppm > 50) aqi += 70;
            else if (data.nh3_ppm > 35) aqi += 50;
            else if (data.nh3_ppm > 25) aqi += 30;
            else if (data.nh3_ppm > 10) aqi += 15;

            // Alcohol contribution
            if (data.alcohol_ppm > 20) aqi += 60;
            else if (data.alcohol_ppm > 15) aqi += 40;
            else if (data.alcohol_ppm > 10) aqi += 25;
            else if (data.alcohol_ppm > 5) aqi += 15;

            // Benzene contribution
            if (data.benzene_ppm > 10) aqi += 150;
            else if (data.benzene_ppm > 5) aqi += 100;
            else if (data.benzene_ppm > 2) aqi += 60;
            else if (data.benzene_ppm > 1) aqi += 30;
            else if (data.benzene_ppm > 0.5) aqi += 15;

            return Math.min(aqi, 500); // Max AQI 500
        }

        // =========================
        // Camera Functions (ditambah)
        // =========================
        function connectCamera() {
            const ipInput = document.getElementById('cameraIpInput');
            const ip = ipInput.value.trim();

            if (!ip) {
                alert('Masukkan IP address ESP32-CAM terlebih dahulu');
                return;
            }

            if (!isValidIP(ip)) {
                alert('Format IP address tidak valid. Contoh: 192.168.1.100');
                return;
            }

            currentCameraIP = ip;
            updateCameraStatus('loading', 'Connecting...');

            const streamUrl = `http://${ip}:81/stream`;
            const cameraStream = document.getElementById('cameraStream');
            const cameraOverlay = document.getElementById('cameraOverlay');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            // Update UI
            connectBtn.disabled = true;
            disconnectBtn.disabled = false;

            // Set stream source
            cameraStream.src = streamUrl;

            // Handle stream load
            cameraStream.onload = function () {
                cameraConnected = true;
                cameraOverlay.style.display = 'none';
                cameraStream.style.display = 'block';
                updateCameraStatus('online', 'Camera Online');
                updateStreamInfo(streamUrl);
                startCameraMonitoring();
            };

            cameraStream.onerror = function () {
                handleCameraError();
            };

            // Set timeout for connection
            setTimeout(() => {
                if (!cameraConnected) {
                    handleCameraError();
                }
            }, 10000); // 10 second timeout
        }

        function disconnectCamera() {
            const cameraStream = document.getElementById('cameraStream');
            const cameraOverlay = document.getElementById('cameraOverlay');
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            // Stop camera monitoring
            if (cameraCheckInterval) {
                clearInterval(cameraCheckInterval);
                cameraCheckInterval = null;
            }

            // Reset UI
            cameraStream.src = '';
            cameraStream.style.display = 'none';
            cameraOverlay.style.display = 'flex';

            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            cameraConnected = false;
            currentCameraIP = '';

            updateCameraStatus('offline', 'Camera Offline');
            updateStreamInfo('Not Connected');
        }

        function handleCameraError() {
            const connectBtn = document.getElementById('connectBtn');
            const disconnectBtn = document.getElementById('disconnectBtn');

            connectBtn.disabled = false;
            disconnectBtn.disabled = true;

            cameraConnected = false;
            updateCameraStatus('offline', 'Connection Failed');

            alert(`Gagal terhubung ke ESP32-CAM di ${currentCameraIP}. Pastikan:\n` +
                `1. ESP32-CAM sudah menyala\n` +
                `2. Terhubung ke WiFi yang sama\n` +
                `3. IP address benar\n` +
                `4. Port 81 tidak terblokir`);
        }

        function updateCameraStatus(status, text) {
            const cameraStatus = document.getElementById('cameraStatus');
            const statusText = cameraStatus.querySelector('span');

            // Remove all status classes
            cameraStatus.classList.remove('online', 'offline', 'loading');

            // Add new status
            cameraStatus.classList.add(status);
            statusText.textContent = text;
        }

        function updateStreamInfo(url) {
            document.getElementById('streamUrl').textContent =
                url === 'Not Connected' ? url : currentCameraIP + ':81/stream';
        }

        function startCameraMonitoring() {
            // Check camera connection every 5 seconds
            cameraCheckInterval = setInterval(() => {
                if (cameraConnected && currentCameraIP) {
                    // Simple ping by trying to load a small image from camera
                    const testImg = new Image();
                    testImg.onload = function () {
                        // Camera is responsive
                        if (!cameraConnected) {
                            updateCameraStatus('online', 'Camera Online');
                            cameraConnected = true;
                        }
                    };
                    testImg.onerror = function () {
                        // Camera is not responsive
                        if (cameraConnected) {
                            updateCameraStatus('offline', 'Camera Disconnected');
                            cameraConnected = false;
                        }
                    };
                    testImg.src = `http://${currentCameraIP}/capture?t=${Date.now()}`;
                }
            }, 5000);
        }

        function isValidIP(ip) {
            const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!regex.test(ip)) return false;

            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        // Auto-refresh page every 30 minutes
        setInterval(() => {
            location.reload();
        }, 1800000);

        // Initialize demo data on load (fallback)
        setTimeout(() => {
            if (!currentData) {
                simulateLocalData();
            }
        }, 2000);
    </script>
</body>

</html>